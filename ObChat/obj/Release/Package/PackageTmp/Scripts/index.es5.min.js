"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),ObChat=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"init",value:function(){return this.threadArray=[],this.accInfo={name:"",id:"",img:""},this.ctrl={fileUpload:$id("imgfile"),sendButton:$id("sendmessage"),canvas:$id("imgCanvas"),textArea:$id("message"),statusMsg:$id("status"),userImageList:$id("userImgList"),container:$id("container")},this.DATA_TYPE={LOGON:"logon",LOGOFF:"logoff",RECEVE_USER_ACCOUNT:"resAcc",MESSAGE:"msg",EVALUATE:"eval"},this.chat=$.connection.ecohHub,this.imageData="",this}},{key:"setHandlers",value:function(){return this.chat.client.broadcastMessage=function(t){if(n.accInfo.id!==""){var i=JSON.parse(t);n.routingJob(i)}},$.connection.hub.start().done(function(){n.ctrl.sendButton.addEventListener("click",function(){var t=n.ctrl.textArea.value;if(t!==""||n.uploadPictureObj.imageData){var i=appHelper.uuid().substr(0,8),r={threadId:i,userName:n.accInfo.name,userId:n.accInfo.id,profImg:n.accInfo.img,content:t,imgData:n.uploadPictureObj.imageData,type:n.DATA_TYPE.MESSAGE},u=JSON.stringify(r);n.post(u)}n.uploadPictureObj.clearPcture(null,0);n.uploadPictureObj.imageData="";n.ctrl.textArea.value=""});var t={name:n.accInfo.name,id:n.accInfo.id,img:n.accInfo.img,type:n.DATA_TYPE.LOGON},i=JSON.stringify(t);n.post(i);n.ctrl.textArea.focus()}),this.uploadPictureObj=new uploadPicture(this.ctrl.fileUpload,this.ctrl.canvas,400),this}},{key:"post",value:function(t){try{n.chat.server.send(t)}catch(i){n.ctrl.statusMsg.innerText="メッセージを送信できませんでした。ページをリフレッシュしてみてください。"}}},{key:"resetStatudBar",value:function(){setTimeout(function(){n.ctrl.statusMsg.innerText="";n.ctrl.statusMsg.className=".status-notice-normal"},3e3)}},{key:"setAccInfo",value:function(t,i,r){n.accInfo.name=t;n.accInfo.id=i;n.accInfo.img=r;var u=$id("profilePic");u.src=r;u.title=t;n.ctrl.fileUpload.disabled=!1;n.ctrl.sendButton.disabled=!1;n.ctrl.textArea.disabled=!1;n.resetStatudBar();$id("userImgListArea").style.display="block";$id("inputBox").style.display="block";n.ctrl.statusMsg.className="status-notice-normal";n.ctrl.statusMsg.innerText=t+" さん、ようこそ。";n.setHandlers()}},{key:"notifyLogoff",value:function(){if(n.accInfo.id!==null&&n.accInfo.id!==""){var t={name:n.accInfo.name,id:n.accInfo.id,type:n.DATA_TYPE.LOGOFF},i=JSON.stringify(t);n.post(i)}}},{key:"notifyLoginOtherUser",value:function(t){var i=t.name+" さんが ObChat にログインしました。";n.ctrl.statusMsg.innerText=i;n.ctrl.statusMsg.className="status-notice-login";n.resetStatudBar()}},{key:"responseAccountInfo",value:function(){var t=this.accInfo,i;t.type=n.DATA_TYPE.RECEVE_USER_ACCOUNT;i=JSON.stringify(t);n.post(i)}},{key:"addUserImage",value:function(t){var i="img"+t.id,r;$id(i)||(r={userId:i,userName:t.name,imgUrl:t.img,fbUrl:"@"},DOMTemplate.bindTemplate(n.ctrl.userImageList,r,DOMTemplate.oderBy.ASC))}},{key:"resetUserImageList",value:function(){var n=this.ctrl.userImageList,t;if(n.childNodes.length)for(t=undefined;t=n.lastChild;)n.removeChild(t)}},{key:"removeUserImage",value:function(t){var i=t.name+" さんが退出しました。",r=$id("img"+t.id);n.ctrl.userImageList.removeChild(r);n.ctrl.statusMsg.innerText=i}},{key:"routingJob",value:function(t){var i,r,u;if(t.type===n.DATA_TYPE.LOGON){t.name!==n.accInfo.name&&(n.notifyLoginOtherUser(t),this.responseAccountInfo(),this.resetUserImageList());this.addUserImage(t);return}if(t.type===n.DATA_TYPE.LOGOFF){this.removeUserImage(t);return}if(t.type===n.DATA_TYPE.RECEVE_USER_ACCOUNT){this.addUserImage(t);return}i=this.whichThread(t.threadId);i?t.type===n.DATA_TYPE.MESSAGE?i.appendReply(t):t.type===n.DATA_TYPE.EVALUATE&&(r=i[t.evalType]+1,i[t.evalType]=r,$id(t.threadId+t.evalType).innerText=r):(u=new ContentThread(t,this.ctrl.container),this.threadArray.push(u))}},{key:"whichThread",value:function(n){for(var i,r=this.threadArray.length,t=0;t<r;t++)if(i=this.threadArray[t],n===i.id)return i;return null}},{key:"evalContent",value:function(t,i){var r={threadId:t,evalType:i,type:n.DATA_TYPE.EVALUATE};n.post(JSON.stringify(r))}},{key:"moveTop",value:function(n){var t=$id(n),i=t.parentNode;t.id!==i.firstChild.id&&i.insertBefore(t,i.firstChild)}}]),n}(),ContentThread=function(){function n(t,i){_classCallCheck(this,n);var u={LIKE:"like",LOVE:"love",FANNY:"fanny",SAD:"sad"},r=t.threadId,f=r+"_text",e=r+"_replys",l=r+u.LIKE,a=r+u.LOVE,v=r+u.FANNY,y=r+u.SAD,o=r+"_reFile",s=r+"_reCnvs";t.replysId=e;t.atclId=r+"_atcl";t.textId=f;t.fbUrl="@";t.imgUrl=t.profImg;t.dateTime=appHelper.getCrrentDatetime();t.currentUserName=ObChat.accInfo.name;t.currentImgUrl=ObChat.accInfo.img;t.likeId=l;t.loveId=a;t.fannyId=v;t.sadId=y;t.reFileId=o;t.reCnvsId=s;t.likeClick="javascript:ObChat.evalContent('"+r+"','"+u.LIKE+"')";t.loveClick="javascript:ObChat.evalContent('"+r+"','"+u.LOVE+"')";t.fannyClick="javascript:ObChat.evalContent('"+r+"','"+u.FANNY+"')";t.sadClick="javascript:ObChat.evalContent('"+r+"','"+u.SAD+"')";DOMTemplate.bindTemplate(i,t,DOMTemplate.oderBy.DESC);var h=$id(f),c=$id(e),p=new uploadPicture($id(o),$id(s),300);h.addEventListener("change",function(n,t,i){return function(){var r=n.id.substr(0,8),u={threadId:r,commentId:r+"_"+t.childNodes.length+"_reply",userName:ObChat.accInfo.name,userId:ObChat.accInfo.id,profImg:ObChat.accInfo.img,content:n.value,type:ObChat.DATA_TYPE.MESSAGE,imgData:i.imageData};i.clearPcture(null,0);i.imageData="";ObChat.post(JSON.stringify(u));n.value=""}}(h,c,p));this.__commentList=c;this.id=r;this.like=0;this.love=0;this.fanny=0;this.sad=0}return _createClass(n,[{key:"appendReply",value:function(n){var t=this.__commentList;n.fbUrl="@";n.imgUrl=n.profImg;n.dateTime=appHelper.getCrrentDatetime();DOMTemplate.bindTemplate(t,n);ObChat.accInfo.name!==n.userName&&(ObChat.ctrl.statusMsg.innerText=n.userName+" さんがあなたの投稿にコメントしました。",ObChat.ctrl.statusMsg.className="status-notice-reply",ObChat.ctrl.statusMsg.addEventListener("click",function(n){return function t(){ObChat.moveTop(n);ObChat.ctrl.statusMsg.className="status-notice-normal";ObChat.ctrl.statusMsg.innerText="";ObChat.ctrl.statusMsg.removeEventListener("click",t,!1)}}(this.id),!1))}}]),n}(),loginBox=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"init",value:function(){var n=this,i=[{imgUrl:this.setPath("icon_124990_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_113190_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_113260_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_113250_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_113270_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_124540_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_124530_48.png"),onclick:"loginBox.handler(event)"}],r=[{imgUrl:this.setPath("icon_124720_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_124660_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_124710_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_113210_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_135050_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_118030_48.png"),onclick:"loginBox.handler(event)"},{imgUrl:this.setPath("icon_124800_48.png"),onclick:"loginBox.handler(event)"}],u=$id("profPicMan"),t;DOMTemplate.bindTemplate(u,i);t=$id("profPicWoman");DOMTemplate.bindTemplate(t,r);this.ctrl={};this.ctrl.loginBox=$id("loginUI");this.ctrl.nameBox=$id("nameBox");this.ctrl.loginButton=$id("loginButton");this.ctrl.loginButton.addEventListener("click",function(){n.ctrl.nameBox.value?n.prvImg?(n.ctrl.loginBox.style.display="none",$id("inputBox").style.display="block",ObChat.init().setAccInfo(n.ctrl.nameBox.value,""+appHelper.uuid(),n.prvImg.src)):alert("使用するアイコンを選択してください。"):(n.ctrl.nameBox.value="ここにお名前を入力してくださいましね。",n.ctrl.nameBox.className="alert_RedFrame",n.ctrl.nameBox.addEventListener("click",function(){n.ctrl.nameBox.select(0,n.ctrl.nameBox.value.length)}))});setTimeout(function(){n.ctrl.nameBox.focus()},1e3)}},{key:"setPath",value:function(n){return"http://assets-images.azurewebsites.net/"+n}},{key:"handler",value:function(n){this.prvImg&&(this.prvImg.className="prof-nomal_img");var t=n.target;t.className="prof-selected_img";this.prvImg=t}}]),n}();window.onload=function(){loginBox.init()};window.onbeforeunload=function(){ObChat.notifyLogoff()};