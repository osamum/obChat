"use strict";function _classCallCheck(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function");}var _createClass=function(){function n(n,t){for(var i,r=0;r<t.length;r++)i=t[r],i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}return function(t,i,r){return i&&n(t.prototype,i),r&&n(t,r),t}}(),Nicebook=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"init",value:function(){return this.threadArray=[],this.accInfo={name:"",id:""},this.ctrl={fileUpload:$id("imgfile"),sendButton:$id("sendmessage"),canvas:$id("imgCanvas"),textArea:$id("message"),statusMsg:$id("status"),userImageList:$id("userImgList")},this.DATA_TYPE={LOGON:"logon",LOGOFF:"logoff",RECEVE_USER_ACCOUNT:"resAcc",MESSAGE:"msg",EVALUATE:"eval"},this.chat=$.connection.ecohHub,this.imageData="",this}},{key:"setHandlers",value:function(){return this.chat.client.broadcastMessage=function(t){if(n.accInfo.id!==""){var i=JSON.parse(t);n.routingJob(i)}},$.connection.hub.start().done(function(){n.ctrl.sendButton.addEventListener("click",function(){var t=n.ctrl.textArea.value;if(t!==""||n.uploadPictureObj.imageData){var i=appHelper.uuid().substr(0,8),r={threadId:i,userName:n.accInfo.name,userId:n.accInfo.id,content:t,imgData:n.uploadPictureObj.imageData,type:n.DATA_TYPE.MESSAGE},u=JSON.stringify(r);n.post(u)}n.uploadPictureObj.clearPcture(null,0);n.uploadPictureObj.imageData="";n.ctrl.textArea.value=""});var t={name:n.accInfo.name,id:n.accInfo.id,type:n.DATA_TYPE.LOGON},i=JSON.stringify(t);n.post(i);n.ctrl.textArea.focus()}),this.uploadPictureObj=new uploadPicture(this.ctrl.fileUpload,this.ctrl.canvas),this}},{key:"post",value:function(t){try{n.chat.server.send(t)}catch(i){n.ctrl.statusMsg.innerText="メッセージを送信できませんでした。ページをリフレッシュしてみてください。"}}},{key:"resetStatudBar",value:function(){setTimeout(function(){n.ctrl.statusMsg.innerText="";n.ctrl.statusMsg.className=".status-notice-normal"},3e3)}},{key:"setAccInfo",value:function(t,i){n.accInfo.name=t;n.accInfo.id=i;var u=mkFbLink(i),r=$id("profilePic");r.src=u.imgUrl;r.title=t;n.ctrl.fileUpload.disabled=!1;n.ctrl.sendButton.disabled=!1;n.ctrl.textArea.disabled=!1;n.resetStatudBar();$id("userImgListArea").style.display="block";n.setHandlers()}},{key:"notifyLogoff",value:function(){if(n.accInfo.id!==""){var t={name:n.accInfo.name,id:n.accInfo.id,type:n.DATA_TYPE.LOGOFF},i=JSON.stringify(t);n.post(i)}}},{key:"notifyLoginOtherUser",value:function(t){var i=t.name+" さんが Nicebook にログインしました。",r=mkFbLink(t.id);n.ctrl.statusMsg.innerText=i;n.ctrl.statusMsg.className="status-notice-login";n.resetStatudBar()}},{key:"responseAccountInfo",value:function(){var t=this.accInfo,i;t.type=n.DATA_TYPE.RECEVE_USER_ACCOUNT;i=JSON.stringify(t);n.post(i)}},{key:"addUserImage",value:function(t){var i=mkFbLink(t.id),r={userId:"img"+t.id,userName:t.name,imgUrl:i.imgUrl,fbUrl:i.fbUrl};DOMTemplate.bindTemplate(n.ctrl.userImageList,r,DOMTemplate.oderBy.ASC)}},{key:"resetUserImageList",value:function(){var n=this.ctrl.userImageList,t;if(n.childNodes.length)for(t=undefined;t=n.lastChild;)n.removeChild(t)}},{key:"removeUserImage",value:function(t){var i=t.name+" さんが退出しました。",r=$id("img"+t.id);n.ctrl.userImageList.removeChild(r);n.ctrl.statusMsg.innerText=i}},{key:"routingJob",value:function(t){var i,r,u;if(t.type===n.DATA_TYPE.LOGON){t.name!==n.accInfo.name&&(n.notifyLoginOtherUser(t),this.responseAccountInfo(),this.resetUserImageList());this.addUserImage(t);return}if(t.type===n.DATA_TYPE.LOGOFF){this.removeUserImage(t);return}if(t.type===n.DATA_TYPE.RECEVE_USER_ACCOUNT){this.addUserImage(t);return}i=this.whichThread(t.threadId);i?t.type===n.DATA_TYPE.MESSAGE?i.appendReply(t):t.type===n.DATA_TYPE.EVALUATE&&(r=i[t.evalType]+1,i[t.evalType]=r,$id(t.threadId+t.evalType).innerText=r):(u=new ContentThread(t,$id("container")),this.threadArray.push(u))}},{key:"whichThread",value:function(n){for(var i,r=this.threadArray.length,t=0;t<r;t++)if(i=this.threadArray[t],n===i.id)return i;return null}},{key:"evalContent",value:function(t,i){var r={threadId:t,evalType:i,type:n.DATA_TYPE.EVALUATE};n.post(JSON.stringify(r))}},{key:"moveTop",value:function(n){var t=$id(n),i=t.parentNode;t.id!==i.firstChild.id&&i.insertBefore(t,i.firstChild)}}]),n}(),ContentThread=function(){function n(t,i){var f,e;_classCallCheck(this,n);var u={LIKE:"like",LOVE:"love",FANNY:"fanny",SAD:"sad"},r=t.threadId,o=r+"_text",s=r+"_replys",c=r+u.LIKE,l=r+u.LOVE,a=r+u.FANNY,v=r+u.SAD,h=mkFbLink(t.userId),y=mkFbLink(Nicebook.accInfo.id);t.replysId=s;t.atclId=r+"_atcl";t.textId=o;t.fbUrl=h.fbUrl;t.imgUrl=h.imgUrl;t.dateTime=appHelper.getCrrentDatetime();t.currentUserName=Nicebook.accInfo.name;t.currentImgUrl=y.imgUrl;t.likeId=c;t.loveId=l;t.fannyId=a;t.sadId=v;t.likeClick="javascript:Nicebook.evalContent('"+r+"','"+u.LIKE+"')";t.loveClick="javascript:Nicebook.evalContent('"+r+"','"+u.LOVE+"')";t.fannyClick="javascript:Nicebook.evalContent('"+r+"','"+u.FANNY+"')";t.sadClick="javascript:Nicebook.evalContent('"+r+"','"+u.SAD+"')";DOMTemplate.bindTemplate(i,t,DOMTemplate.oderBy.DESC);f=$id(o);e=$id(s);f.addEventListener("change",function(n,t){return function(){var i=n.id.substr(0,8),r={threadId:i,commentId:i+"_"+t.childNodes.length+"_reply",userName:Nicebook.accInfo.name,userId:Nicebook.accInfo.id,content:n.value,type:Nicebook.DATA_TYPE.MESSAGE};Nicebook.post(JSON.stringify(r));n.value=""}}(f,e));this.__commentList=e;this.id=r;this.like=0;this.love=0;this.fanny=0;this.sad=0}return _createClass(n,[{key:"appendReply",value:function(n){var t=mkFbLink(n.userId),i=this.__commentList;n.fbUrl=t.fbUrl;n.imgUrl=t.imgUrl;n.dateTime=appHelper.getCrrentDatetime();DOMTemplate.bindTemplate(i,n);Nicebook.accInfo.name!==n.userName&&(Nicebook.ctrl.statusMsg.innerText=n.userName+" さんがあなたの投稿にコメントしました。",Nicebook.ctrl.statusMsg.className="status-notice-reply",Nicebook.ctrl.statusMsg.addEventListener("click",function(n){return function t(){Nicebook.moveTop(n);Nicebook.ctrl.statusMsg.className="status-notice-normal";Nicebook.ctrl.statusMsg.innerText="";Nicebook.ctrl.statusMsg.removeEventListener("click",t,!1)}}(this.id),!1))}}]),n}();window.onload=function(){Nicebook.init().setAccInfo("Osamu Monoe","100002070715086")};window.onbeforeunload=function(){};